@using English_ZP3_Project.Models
@using System.IO
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

@{
    ViewData["Title"] = "Glossary";

    // Prefer Views, fall back to Pages (Razor Pages projects use Pages)
    var viewsRoot = System.IO.Path.Combine(Env.ContentRootPath, "Views");
    if (!System.IO.Directory.Exists(viewsRoot))
    {
        viewsRoot = System.IO.Path.Combine(Env.ContentRootPath, "Pages");
    }

    var firstMap = RelatedWord.BuildFirstAppearanceMap(viewsRoot);

    // Helper: build a route for a file (supports Pages and Views)
    string BuildRouteFromFile(string root, string file)
    {
        var relative = System.IO.Path.GetRelativePath(root, file);
        // Razor Pages mapping
        if (string.Equals(System.IO.Path.GetFileName(root), "Pages", StringComparison.OrdinalIgnoreCase))
        {
            var route = relative.Replace(System.IO.Path.DirectorySeparatorChar, '/').Replace(".cshtml", "");
            // treat /Index as folder route
            if (route.EndsWith("/Index", StringComparison.OrdinalIgnoreCase))
            {
                route = route.Substring(0, route.Length - "/Index".Length);
            }
            route = "/" + route.Trim('/');
            if (route == "/") route = "/";
            return route;
        }
        // MVC Views mapping: /Controller/Action
        var parts = relative.Split(System.IO.Path.DirectorySeparatorChar);
        var controller = parts.Length >= 1 ? parts[0] : "Home";
        var action = System.IO.Path.GetFileNameWithoutExtension(parts[parts.Length - 1]);
        return $"/{controller}/{action}";
    }

    bool IsForbiddenRoute(string route)
    {
        if (string.IsNullOrEmpty(route)) return true;
        // remove fragment if present
        var routeOnly = route.Split('#')[0];
        // Normalize for checks
        routeOnly = routeOnly.Trim();
        if (string.IsNullOrEmpty(routeOnly)) return true;
        // Forbidden if root/index or Conclusion controller/page
        if (string.Equals(routeOnly, "/", StringComparison.OrdinalIgnoreCase)) return true;
        if (routeOnly.EndsWith("/Index", StringComparison.OrdinalIgnoreCase)) return true;
        if (routeOnly.IndexOf("/Conclusion", StringComparison.OrdinalIgnoreCase) >= 0) return true;
        return false;
    }
}

<a id="top"></a>
<h2>Glossary</h2>

@foreach (var word in Word.GetGlossary())
{
    var safeId = word.Id; // canonical id generated by Word
    var defaultLink = word.Link;
    // prefer the precomputed first-appearance link
    var link = firstMap.TryGetValue(word.Text, out var firstLink) ? firstLink : defaultLink;

    // If the resolved link points to the glossary itself or a forbidden route, try to find any other file containing the word.
    if (IsForbiddenRoute(link))
    {
        foreach (var file in System.IO.Directory.GetFiles(viewsRoot, "*.cshtml", SearchOption.AllDirectories))
        {
            var fname = System.IO.Path.GetFileName(file);
            if (fname.StartsWith("_", StringComparison.OrdinalIgnoreCase)) continue;
            if (fname.Equals("Glossary.cshtml", StringComparison.OrdinalIgnoreCase)) continue;

            string content;
            try { content = System.IO.File.ReadAllText(file); }
            catch { continue; }

            var pattern = System.Text.RegularExpressions.Regex.Escape(word.Text);
            var rx = new System.Text.RegularExpressions.Regex($@"(?<!\w){pattern}(?!\w)", System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.CultureInvariant);
            if (rx.IsMatch(content))
            {
                // build route and append fragment for the glossary id
                var candidate = BuildRouteFromFile(viewsRoot, file);
                if (IsForbiddenRoute(candidate)) continue; // skip Conclusion/Index/etc.
                link = $"{candidate}#{safeId}";
                break;
            }
        }

        // if not found, link remains the glossary anchor (fallback)
    }

    <div class="glossary-entry" id="@safeId" style="margin-bottom:20px;">
        <strong>
            <a href="@link" style="color:inherit; text-decoration:none;">@word.Text</a>
        </strong>
        <strong style="color:lightblue"> / @word.WordClass</strong>
        
        <br />
        @word.Definition
        <br />
    </div>
}
